stages:
  - merge
  - deploy

merge_to_main:
  stage: merge
  only:
    - dev
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-add ~/.ssh/id_rsa
    - ssh-keyscan -H gitlab.com >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI/CD"
  script:
    - git checkout main
    - git pull origin main
    - git merge origin/dev --no-edit
    - git push origin main

deploy_production:
  stage: deploy
  only:
    - main
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-add ~/.ssh/id_rsa
    - ssh-keyscan -H 160.250.134.174 >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "ðŸš€ Deploying to production..."
    - |
      ssh deploy@160.250.134.174 << 'ENDSSH'
        set -e

        # Load NVM if exists
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

        # Add GitLab to known_hosts if not already present
        mkdir -p ~/.ssh
        ssh-keyscan -H gitlab.com >> ~/.ssh/known_hosts 2>/dev/null || true

        cd /home/deploy/in-promac-fe-2025

        echo "ðŸ“¥ Pulling latest code..."
        git pull origin main

        echo "ðŸ“¦ Installing dependencies..."
        npm i

        echo "ðŸ”¨ Building application..."
        npm run build

        echo "ðŸ”„ Restarting PM2 (ID: 22)..."
        pm2 restart 22

        echo "âœ… Deployed successfully!"
      ENDSSH
